<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>astracatCloud DNS IPV4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-center mb-6">astracatCloud DNS IPV4</h1>
        <div id="metrics" class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4">Основные показатели</h2>
            <div id="loading" class="text-center">Загрузка данных...</div>
            <div id="error" class="text-red-500 hidden">Ошибка загрузки данных. Пожалуйста, попробуйте позже.</div>
            <table class="w-full border-collapse hidden" id="metricsTable">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2">Параметр</th>
                        <th class="border p-2">Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="border p-2">Количество объектов в куче</td>
                        <td class="border p-2" id="heap_objects"></td>
                    </tr>
                    <tr>
                        <td class="border p-2">Успешные запросы (код 200)</td>
                        <td class="border p-2" id="requests_total"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">График метрик</h2>
            <canvas id="metricsChart" width="400" height="200"></canvas>
        </div>
    </div>

    <script>
        // Хранилище для данных графика (последние 10 точек)
        const chartData = {
            labels: [],
            heapObjects: [],
            requestsTotal: []
        };

        // Инициализация графика
        const ctx = document.getElementById('metricsChart').getContext('2d');
        const metricsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Объекты в куче',
                        data: chartData.heapObjects,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Успешные запросы (код 200)',
                        data: chartData.requestsTotal,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Время' }
                    },
                    y: {
                        title: { display: true, text: 'Значение' },
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        });

        async function fetchMetrics() {
            try {
                const response = await axios.get('/metrics');
                if (response.data.error) {
                    throw new Error(response.data.error);
                }
                const metrics = response.data;
                displayMetrics(metrics);
                updateChart(metrics);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('metricsTable').classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching metrics:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('error').textContent = `Ошибка: ${error.message}`;
            }
        }

        function displayMetrics(metrics) {
            document.getElementById('heap_objects').textContent = metrics.heap_objects ? Math.round(metrics.heap_objects).toLocaleString() : '0';
            document.getElementById('requests_total').textContent = metrics.requests_total ? Math.round(metrics.requests_total).toLocaleString() : '0';
        }

        function updateChart(metrics) {
            // Добавляем новое время (текущая метка времени)
            const now = new Date().toLocaleTimeString();
            chartData.labels.push(now);
            chartData.heapObjects.push(metrics.heap_objects || 0);
            chartData.requestsTotal.push(metrics.requests_total || 0);

            // Ограничиваем до 10 точек
            if (chartData.labels.length > 10) {
                chartData.labels.shift();
                chartData.heapObjects.shift();
                chartData.requestsTotal.shift();
            }

            // Обновляем график
            metricsChart.data.labels = chartData.labels;
            metricsChart.data.datasets[0].data = chartData.heapObjects;
            metricsChart.data.datasets[1].data = chartData.requestsTotal;
            metricsChart.update();
        }

        fetchMetrics();
        setInterval(fetchMetrics, 60000); // Обновление каждую минуту
    </script>
</body>
</html>
